<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy & Auth Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module" src="./storage.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 p-6 font-mono">

    <div class="max-w-3xl mx-auto space-y-6">
        
        <header class="border-b border-slate-700 pb-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-teal-400">Step 89: Privacy & Deletion</h1>
                <p class="text-xs text-slate-400">Testet Löschung von Cloud-Daten bei Modus-Wechsel.</p>
            </div>
            <div id="auth-badge" class="px-3 py-1 rounded bg-slate-800 text-slate-400 text-xs font-bold">
                Checking Auth...
            </div>
        </header>

        <!-- 1. AUTH MODE SELECTION -->
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 flex gap-2">
                <i data-lucide="shield" class="w-4 h-4"></i> Datensicherheit & Login
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Lokal -->
                <button id="btn-mode-local" class="p-4 rounded-lg border border-slate-600 hover:bg-slate-700 transition text-left group">
                    <div class="text-slate-300 font-bold group-hover:text-white flex items-center gap-2">
                        <i data-lucide="hard-drive" class="w-4 h-4"></i> Nur Lokal
                    </div>
                    <div class="text-[10px] text-slate-500 mt-1">Trennt Verbindung. Fragt nach Cloud-Löschung.</div>
                </button>

                <!-- Anonym -->
                <button id="btn-mode-anon" class="p-4 rounded-lg border border-indigo-600/50 bg-indigo-900/10 hover:bg-indigo-900/30 transition text-left group">
                    <div class="text-indigo-300 font-bold group-hover:text-indigo-200 flex items-center gap-2">
                        <i data-lucide="ghost" class="w-4 h-4"></i> Anonym
                    </div>
                    <div class="text-[10px] text-indigo-400/60 mt-1">Sync via Code. Temporärer Speicher.</div>
                </button>

                <!-- Google -->
                <button id="btn-mode-google" class="p-4 rounded-lg border border-blue-600/50 bg-blue-900/10 hover:bg-blue-900/30 transition text-left group">
                    <div class="text-blue-300 font-bold group-hover:text-blue-200 flex items-center gap-2">
                        <i data-lucide="mail" class="w-4 h-4"></i> Google
                    </div>
                    <div class="text-[10px] text-blue-400/60 mt-1">Dauerhaft & Sicher.</div>
                </button>
            </div>

            <!-- Current ID Display -->
            <div class="mt-4 p-3 bg-black/30 rounded border border-slate-700/50 flex justify-between items-center">
                <div class="text-xs">
                    <span class="text-slate-500">Aktuelle UID:</span>
                    <span id="disp-uid" class="text-slate-300 ml-2 font-mono">---</span>
                </div>
                <div class="text-xs">
                    <span class="text-slate-500">Short ID:</span>
                    <span id="disp-short-id" class="text-indigo-400 ml-2 font-black">---</span>
                </div>
            </div>
        </div>

        <!-- Log Output -->
        <div class="bg-black p-4 rounded-xl border border-slate-800 font-mono text-xs h-48 overflow-y-auto custom-scrollbar" id="console-log">
            <div class="text-slate-500 italic">System ready...</div>
        </div>

    </div>

    <script>
        const logArea = document.getElementById('console-log');
        function log(msg, type = 'info') {
            const el = document.createElement('div');
            const ts = new Date().toISOString().split('T')[1].split('.')[0];
            let color = 'text-slate-300';
            if(type === 'error') color = 'text-red-400 font-bold';
            if(type === 'success') color = 'text-green-400 font-bold';
            if(type === 'warn') color = 'text-orange-300 font-bold';
            el.className = `mb-1 ${color}`;
            el.innerHTML = `<span class="opacity-50">[${ts}]</span> ${msg}`;
            logArea.appendChild(el);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateAuthUI(user) {
            const badge = document.getElementById('auth-badge');
            const uidDisp = document.getElementById('disp-uid');
            
            if (user) {
                const isAnon = user.isAnonymous; 
                badge.textContent = isAnon ? "Angemeldet (Anonym)" : "Angemeldet (Google)";
                badge.className = isAnon ? "px-3 py-1 rounded bg-indigo-900 text-indigo-200 text-xs font-bold" : "px-3 py-1 rounded bg-blue-900 text-blue-200 text-xs font-bold";
                uidDisp.textContent = user.uid;
            } else {
                badge.textContent = "Lokal (Nicht angemeldet)";
                badge.className = "px-3 py-1 rounded bg-slate-700 text-slate-400 text-xs font-bold";
                uidDisp.textContent = "---";
            }
        }

        async function refreshShortID(state) {
            const uid = window.VTrainerCloud.getUID();
            const disp = document.getElementById('disp-short-id');
            if(state.settings.cloudShortId) {
                disp.textContent = state.settings.cloudShortId;
            } else if (uid) {
                const id = await window.VTrainerCloud.getOrRegisterShortId(uid, state);
                disp.textContent = id || "(Generiere...)";
            } else {
                disp.textContent = "---";
            }
        }

        setTimeout(async () => {
            if(window.lucide) lucide.createIcons();
            window.VTrainerCloud.initAuth().then(user => {
                updateAuthUI(user);
                const state = window.VTrainer.loadState();
                refreshShortID(state);
            });
        }, 500);

        // --- BUTTON HANDLERS ---

        // 1. LOCAL MODE (MIT DATENSCHUTZ-ABFRAGE)
        document.getElementById('btn-mode-local').onclick = async () => {
            const currentUser = window.VTrainerCloud.getUser();
            const state = window.VTrainer.loadState();

            if (!currentUser && !state.settings.isCloudEnabled) {
                log("Bereits im lokalen Modus.", 'info');
                return;
            }

            // A) Bestätigung für Wechsel
            if (!confirm("Verbindung zur Cloud trennen und in den lokalen Modus wechseln?")) {
                return;
            }

            // B) Datenschutz-Abfrage
            let deleteCloud = false;
            if (currentUser) {
                deleteCloud = confirm(
                    "DATENSCHUTZ:\n\n" +
                    "Möchtest du deine Daten in der Cloud (inkl. Lernfortschritt) endgültig löschen?\n\n" +
                    "OK = Ja, löschen (Account wird bereinigt)\n" +
                    "Abbrechen = Nein, Daten behalten (für späteres Login)"
                );
            }

            log("Führe Modus-Wechsel aus...", 'warn');

            try {
                if (deleteCloud && currentUser) {
                    log("Lösche Cloud-Daten...", 'warn');
                    await window.VTrainerCloud.deleteCompleteUserData(currentUser.uid, state.settings.cloudShortId);
                    log("Daten gelöscht.", 'success');
                }

                // C) Logout & State Reset
                await window.VTrainerCloud.logout();
                
                state.settings.isCloudEnabled = false;
                state.settings.authMethod = 'local';
                state.settings.cloudShortId = null; // Short ID lokal vergessen
                window.VTrainer.saveState(state);

                updateAuthUI(null);
                refreshShortID(state);
                log("Erfolgreich auf 'Nur Lokal' gewechselt.", 'success');
                alert("Du bist jetzt im lokalen Modus.");

            } catch(e) {
                log("Fehler beim Wechsel: " + e.message, 'error');
            }
        };

        // 2. ANONYMOUS
        document.getElementById('btn-mode-anon').onclick = async () => {
            log("Starte Anonyme Anmeldung...");
            try {
                const user = await window.VTrainerCloud.loginAnonymous();
                const state = window.VTrainer.loadState();
                state.settings.isCloudEnabled = true;
                state.settings.authMethod = 'anonymous';
                const id = await window.VTrainerCloud.getOrRegisterShortId(user.uid, state);
                window.VTrainer.saveState(state);
                log(`Anonym eingeloggt. ID: ${id}`, 'success');
                updateAuthUI(user);
                refreshShortID(state);
            } catch(e) { log("Fehler: " + e.message, 'error'); }
        };

        // 3. GOOGLE
        document.getElementById('btn-mode-google').onclick = async () => {
            const currentUser = window.VTrainerCloud.getUser();
            if (currentUser && currentUser.isAnonymous) {
                if(confirm("Anonymen Account in Google Account umwandeln?")) {
                    try {
                        const user = await window.VTrainerCloud.upgradeToGoogle();
                        log("Upgrade erfolgreich!", 'success');
                        const state = window.VTrainer.loadState();
                        state.settings.authMethod = 'google';
                        window.VTrainer.saveState(state);
                        updateAuthUI(user);
                        return;
                    } catch(e) { 
                        log("Upgrade Fehler: " + e.message, 'error');
                        if(e.code === 'auth/credential-already-in-use') alert("Google Account wird schon verwendet.");
                        return;
                    }
                }
            }
            try {
                const user = await window.VTrainerCloud.loginGoogle();
                const state = window.VTrainer.loadState();
                state.settings.isCloudEnabled = true;
                state.settings.authMethod = 'google';
                window.VTrainer.saveState(state);
                log("Google Login erfolgreich.", 'success');
                updateAuthUI(user);
                refreshShortID(state);
            } catch(e) { log("Google Login Fehler: " + e.message, 'error'); }
        };
    </script>
</body>
</html>
